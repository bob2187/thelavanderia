---
# PINN Image Preparation Role
# Prepares a PINN SD card with SSH, VNC, and Tailscale pre-configured

- name: Install required packages
  ansible.builtin.apt:
    name:
      - unzip
      - wget
      - parted
      - dosfstools
    state: present
  become: true

- name: Create working directory
  ansible.builtin.file:
    path: "{{ pinn_work_dir }}"
    state: directory
    mode: '0755'

- name: Create mount point
  ansible.builtin.file:
    path: "{{ pinn_mount_point }}"
    state: directory
    mode: '0755'
  become: true

- name: Check if target device exists
  ansible.builtin.stat:
    path: "{{ pinn_target_device }}"
  register: target_device
  become: true

- name: Fail if target device not found
  ansible.builtin.fail:
    msg: "Target device {{ pinn_target_device }} not found. Please insert SD card."
  when: not target_device.stat.exists

- name: Unmount any existing partitions on target device
  ansible.builtin.shell: |
    umount {{ pinn_target_device }}* 2>/dev/null || true
  become: true
  changed_when: false

- name: Download PINN
  ansible.builtin.get_url:
    url: "{{ pinn_download_url }}"
    dest: "{{ pinn_work_dir }}/pinn-lite.zip"
    mode: '0644'

- name: Create partition table on SD card
  ansible.builtin.shell: |
    parted -s {{ pinn_target_device }} mklabel msdos
    parted -s {{ pinn_target_device }} mkpart primary fat32 1MiB 100%
    parted -s {{ pinn_target_device }} set 1 boot on
    parted -s {{ pinn_target_device }} set 1 lba on
  become: true

- name: Wait for partition to appear
  ansible.builtin.wait_for:
    path: "{{ pinn_target_device }}1"
    timeout: 10
  become: true

- name: Format partition as FAT32
  ansible.builtin.shell: |
    mkfs.vfat -F 32 -n PINN {{ pinn_target_device }}1
  become: true

- name: Mount PINN partition
  ansible.posix.mount:
    path: "{{ pinn_mount_point }}"
    src: "{{ pinn_target_device }}1"
    fstype: vfat
    state: mounted
  become: true

- name: Extract PINN to SD card
  ansible.builtin.unarchive:
    src: "{{ pinn_work_dir }}/pinn-lite.zip"
    dest: "{{ pinn_mount_point }}"
    remote_src: true
  become: true

- name: Configure cmdline.txt with SSH, VNC, and passwords
  ansible.builtin.template:
    src: cmdline.txt.j2
    dest: "{{ pinn_mount_point }}/cmdline.txt"
    mode: '0644'
  become: true

# Tailscale setup
- name: Create tailscale directory on PINN partition
  ansible.builtin.file:
    path: "{{ pinn_mount_point }}/tailscale"
    state: directory
    mode: '0755'
  become: true

- name: Download Tailscale static binary
  ansible.builtin.get_url:
    url: "https://pkgs.tailscale.com/stable/tailscale_{{ tailscale_version }}_{{ tailscale_arch }}.tgz"
    dest: "{{ pinn_work_dir }}/tailscale.tgz"
    mode: '0644'

- name: Extract Tailscale binary
  ansible.builtin.unarchive:
    src: "{{ pinn_work_dir }}/tailscale.tgz"
    dest: "{{ pinn_work_dir }}"
    remote_src: true

- name: Copy Tailscale binaries to PINN partition
  ansible.builtin.copy:
    src: "{{ pinn_work_dir }}/tailscale_{{ tailscale_version }}_{{ tailscale_arch }}/{{ item }}"
    dest: "{{ pinn_mount_point }}/tailscale/{{ item }}"
    mode: '0755'
    remote_src: true
  become: true
  loop:
    - tailscale
    - tailscaled

- name: Copy Tailscale init script
  ansible.builtin.copy:
    src: tailscale-init.sh
    dest: "{{ pinn_mount_point }}/tailscale/init.sh"
    mode: '0755'
  become: true

- name: Write Tailscale auth key
  ansible.builtin.copy:
    content: "{{ tailscale_auth_key }}"
    dest: "{{ pinn_mount_point }}/tailscale/authkey"
    mode: '0600'
  become: true
  when: tailscale_auth_key is defined and tailscale_auth_key | length > 0

# Create a custom recovery hook to run Tailscale
- name: Create custom init hook for Tailscale
  ansible.builtin.copy:
    content: |
      #!/bin/sh
      # Mount boot partition and run Tailscale init
      BOOT_PART=$(findmnt -n -o SOURCE /)
      BOOT_MOUNT=$(dirname $(findmnt -n -o TARGET /))

      # Try to find and run tailscale init
      if [ -f /mnt/tailscale/init.sh ]; then
        /mnt/tailscale/init.sh &
      elif [ -f /boot/tailscale/init.sh ]; then
        /boot/tailscale/init.sh &
      fi
    dest: "{{ pinn_mount_point }}/custom/99-tailscale.sh"
    mode: '0755'
  become: true
  ignore_errors: true

- name: Sync filesystem
  ansible.builtin.command: sync
  become: true

- name: Unmount PINN partition
  ansible.posix.mount:
    path: "{{ pinn_mount_point }}"
    state: unmounted
  become: true

- name: Clean up working directory
  ansible.builtin.file:
    path: "{{ pinn_work_dir }}"
    state: absent

- name: Display completion message
  ansible.builtin.debug:
    msg: |
      PINN SD card prepared successfully!

      Configuration:
      - SSH enabled (root / {{ pinn_ssh_password }})
      - VNC enabled (port 5900, password: {{ pinn_vnc_password }})
      - Tailscale binaries installed

      To complete Tailscale setup in PINN:
      1. Boot the Pi with this SD card
      2. SSH to the Pi: ssh root@<ip>
      3. Run: /mnt/mmcblk0p1/tailscale/init.sh

      Or if auto-init works, Tailscale should connect automatically.
