---
# Companion role: Build Bitfocus Companion from source (GUI version with tray icon)

- name: Install build dependencies
  apt:
    name:
      - git
      - build-essential
      - libusb-1.0-0-dev
      - libudev-dev
      - libfontconfig1
      - libgtk-3-0
      - libnotify4
      - libnss3
      - libxss1
      - libxtst6
      - xdg-utils
      - ca-certificates
      - curl
      - gnupg
    state: present

- name: Create keyrings directory
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'

- name: Download NodeSource GPG key
  shell: curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg
  args:
    creates: /etc/apt/keyrings/nodesource.gpg

- name: Add NodeSource repository
  copy:
    dest: /etc/apt/sources.list.d/nodesource.list
    content: |
      deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_22.x nodistro main
    mode: '0644'

- name: Update apt cache after adding NodeSource
  apt:
    update_cache: yes

- name: Install Node.js 22
  apt:
    name: nodejs
    state: present

- name: Enable corepack for Yarn
  command: corepack enable

- name: Prepare Yarn via corepack
  command: corepack prepare yarn@stable --activate
  environment:
    COREPACK_ENABLE_DOWNLOAD_PROMPT: "0"

- name: Clone Companion repository
  git:
    repo: https://github.com/bitfocus/companion.git
    dest: /opt/companion
    version: "{{ companion_version | default('main') }}"
    force: yes

- name: Install Companion dependencies with Yarn
  command: yarn install
  args:
    chdir: /opt/companion
  environment:
    HOME: "/root"
    COREPACK_ENABLE_DOWNLOAD_PROMPT: "0"

- name: Build Companion TypeScript
  command: yarn build:ts
  args:
    chdir: /opt/companion
  environment:
    HOME: "/root"
    COREPACK_ENABLE_DOWNLOAD_PROMPT: "0"

- name: Set Companion ownership
  file:
    path: /opt/companion
    owner: "{{ admin_user }}"
    group: "{{ admin_user }}"
    recurse: yes

- name: Create autostart directory
  file:
    path: "/home/{{ admin_user }}/.config/autostart"
    state: directory
    owner: "{{ admin_user }}"
    group: "{{ admin_user }}"
    mode: '0755'

- name: Create Companion autostart entry
  copy:
    dest: "/home/{{ admin_user }}/.config/autostart/companion.desktop"
    content: |
      [Desktop Entry]
      Type=Application
      Name=Bitfocus Companion
      Exec=yarn --cwd /opt/companion dev
      Terminal=false
      StartupNotify=false
      X-GNOME-Autostart-enabled=true
    owner: "{{ admin_user }}"
    group: "{{ admin_user }}"
    mode: '0644'

- name: Companion info
  debug:
    msg: "Companion {{ companion_version | default('main') }} built. Log into desktop or reboot to start. Access at http://{{ inventory_hostname }}:8000"
