---
# Companion role: Install Bitfocus Companion (pre-built with tray icon)
# Requires: Download the linux-arm64 tar.gz from bitfocus.io and place in files/

- name: Install dependencies
  apt:
    name:
      - libusb-1.0-0-dev
      - libudev-dev
      - libfontconfig1
      - libgtk-3-0
      - libnotify4
      - libnss3
      - libxss1
      - libxtst6
      - xdg-utils
      - libgbm1
      - libasound2
    state: present

- name: Check if Companion is already installed
  stat:
    path: /home/{{ admin_user }}/Desktop/companion/companion-launcher
  register: companion_installed

- name: Create companion directory
  file:
    path: /home/{{ admin_user }}/Desktop/companion
    state: directory
    mode: '0755'
  when: not companion_installed.stat.exists

- name: Copy Companion archive
  copy:
    src: "companion-linux-arm64.tar.gz"
    dest: /tmp/companion.tar.gz
    mode: '0644'
  when: not companion_installed.stat.exists

- name: Extract Companion
  unarchive:
    src: /tmp/companion.tar.gz
    dest: /home/{{ admin_user }}/Desktop/companion
    remote_src: yes
    extra_opts: [--strip-components=1]
  when: not companion_installed.stat.exists

- name: Clean up archive
  file:
    path: /tmp/companion.tar.gz
    state: absent

- name: Set Companion ownership
  file:
    path: /home/{{ admin_user }}/Desktop/companion
    owner: "{{ admin_user }}"
    group: "{{ admin_user }}"
    recurse: yes

- name: Install udev rules for USB devices
  copy:
    src: /home/{{ admin_user }}/Desktop/companion/50-companion-desktop.rules
    dest: /etc/udev/rules.d/50-companion.rules
    remote_src: yes
    mode: '0644'
  notify: reload udev

- name: Create autostart directory
  file:
    path: "/home/{{ admin_user }}/.config/autostart"
    state: directory
    owner: "{{ admin_user }}"
    group: "{{ admin_user }}"
    mode: '0755'

- name: Create Companion autostart entry
  copy:
    dest: "/home/{{ admin_user }}/.config/autostart/companion.desktop"
    content: |
      [Desktop Entry]
      Type=Application
      Name=Bitfocus Companion
      Exec=/home/{{ admin_user }}/Desktop/companion/companion-launcher
      Terminal=false
      StartupNotify=false
      X-GNOME-Autostart-enabled=true
    owner: "{{ admin_user }}"
    group: "{{ admin_user }}"
    mode: '0644'

- name: Companion info
  debug:
    msg: "Companion installed. Reboot or log into desktop to start. Access at http://{{ inventory_hostname }}:8000"
