---
# Tailscale update role for OpenWRT/GL.iNET routers
# Downloads latest Tailscale on localhost, pushes binaries to router
# Skipped when tailscale_managed is false (e.g., bridge-mode APs)
#
# IMPORTANT: If connecting via Tailscale IP, we must push binaries
# before stopping Tailscale, then do a quick stop+start to avoid
# losing our SSH connection mid-update.

- name: Skip Tailscale update (not managed)
  debug:
    msg: "Skipping Tailscale update â€” tailscale_managed is false for {{ inventory_hostname }}"
  when: not tailscale_managed

- name: Update Tailscale
  when: tailscale_managed
  block:
    - name: Get current Tailscale version
      command: tailscale version
      register: current_version
      changed_when: false
      failed_when: false

    - name: Display current version
      debug:
        msg: "Current Tailscale version: {{ current_version.stdout_lines[0] | default('not installed') }}"

    - name: Get latest Tailscale version
      uri:
        url: https://pkgs.tailscale.com/stable/?mode=json
        return_content: yes
      register: tailscale_releases
      delegate_to: localhost
      become: no

    - name: Set latest version fact
      set_fact:
        latest_version: "{{ (tailscale_releases.content | from_json).TarballsVersion }}"

    - name: Display latest version
      debug:
        msg: "Latest Tailscale version: {{ latest_version }}"

    - name: Check if update needed
      set_fact:
        update_needed: "{{ current_version.stdout_lines[0] | default('0') != latest_version }}"

    - name: Download latest Tailscale on localhost
      get_url:
        url: "https://pkgs.tailscale.com/stable/tailscale_{{ latest_version }}_arm64.tgz"
        dest: "/tmp/tailscale_{{ latest_version }}_arm64.tgz"
        mode: '0644'
      delegate_to: localhost
      become: no
      run_once: true
      when: update_needed

    - name: Extract Tailscale on localhost
      shell: |
        cd /tmp
        tar -xzf tailscale_{{ latest_version }}_arm64.tgz
      delegate_to: localhost
      become: no
      run_once: true
      when: update_needed

    - name: Stage tailscale binary to /tmp on router
      copy:
        src: "/tmp/tailscale_{{ latest_version }}_arm64/tailscale"
        dest: /tmp/tailscale_new
        mode: '0755'
      when: update_needed

    - name: Stage tailscaled binary to /tmp on router
      copy:
        src: "/tmp/tailscale_{{ latest_version }}_arm64/tailscaled"
        dest: /tmp/tailscaled_new
        mode: '0755'
      when: update_needed

    - name: Stop Tailscale, swap binaries, and restart
      raw: |
        /etc/init.d/tailscale stop 2>/dev/null
        mv /tmp/tailscale_new /usr/sbin/tailscale
        mv /tmp/tailscaled_new /usr/sbin/tailscaled
        /etc/init.d/tailscale start
      when: update_needed

    - name: Clean up localhost download
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - "/tmp/tailscale_{{ latest_version }}_arm64.tgz"
        - "/tmp/tailscale_{{ latest_version }}_arm64"
      delegate_to: localhost
      become: no
      run_once: true
      when: update_needed

    - name: Update summary
      debug:
        msg: "{{ 'Tailscale updated from ' + current_version.stdout_lines[0] + ' to ' + latest_version if update_needed else 'Tailscale already at latest version ' + latest_version }}"
