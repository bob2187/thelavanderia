---
# Base role for OpenWRT routers: hostname and SSH key deployment

- name: Get current hostname
  raw: uci get system.@system[0].hostname
  register: current_hostname
  changed_when: false

- name: Set hostname
  raw: uci set system.@system[0].hostname='{{ inventory_hostname }}' && uci commit system && /etc/init.d/system reload
  when: current_hostname.stdout | trim != inventory_hostname

- name: Display hostname status
  debug:
    msg: "{{ 'Hostname changed from ' + current_hostname.stdout | trim + ' to ' + inventory_hostname if current_hostname.stdout | trim != inventory_hostname else 'Hostname already set to ' + inventory_hostname }}"

- name: Deploy SSH authorized keys to dropbear
  raw: |
    mkdir -p /etc/dropbear
    cat > /etc/dropbear/authorized_keys << 'KEYS'
    {% for key in admin_ssh_keys %}
    {{ key }}
    {% endfor %}
    KEYS
    chmod 600 /etc/dropbear/authorized_keys
  when: admin_ssh_keys | default([]) | length > 0

- name: Check Samba veto files config for macOS compatibility
  raw: grep -c '/\._\*/' /etc/samba/smb.conf.template 2>/dev/null || echo "0"
  register: samba_veto_check
  changed_when: false
  failed_when: false

- name: Fix Samba veto files to include all AppleDouble resource forks
  raw: >
    sed -i 's|veto files = /Thumbs.db/.DS_Store/._.DS_Store/.apdisk/|veto files = /Thumbs.db/.DS_Store/._*/.apdisk/|'
    /etc/samba/smb.conf.template &&
    /etc/init.d/samba4 restart
  when: samba_veto_check.stdout | trim == "0"
